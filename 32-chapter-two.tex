\chapter{Вторая глава. Программная реализация алгоритма}
\label{cha:ch_2}
\section{Общая схема вычислений}

\par
В рассмотренных далее примерах рассматривалась вероятностная реализация алгоритма MCCFR. При использовании данного метода значения случайных событий генерируются перед началом каждой обучающей итерации. Данный подход позволяет сократить обьем памяти и ускорить вычисления в некоторых случаях\cite{MCCFR}.
При реализации примеров были выделены следующие компоненты:
\begin{itemize}
	\item настройки игры (произвольная параметризация составных частей игры);
	\item описание правил игры (зависит от настроек);
	\item модуль с реализацией алгоритма относительно определенных правил и настроек.
\end{itemize}
\par
Настройки игры, например, по возможности могут включать число игроков, состав костяшек домино и т.п.
\par
Правила игры включают структуру игрового дерева, механизм распределения случайных событий и функцию выплат. Игровое дерево строится с применением узлов -- обьектов с информацией о историии игры, о игроке и о возможных действиях.
\par
Сам расчет итераций CFR происходит в выделенном модуле, на основе, определенных для каждого конкретного случая, правил игры. Работа алгоритма начинается с создания игрового дерева. Далее происходит расчет заданного числа итераций. После любой итерации можно получить средние стратегии игроков, которые представляют из себя приближенное коррелирующее равновесие.
\section{Первый пример. Покер Куна}

Покер Куна – это максимально упрощенная версия карточной игры покер\cite{KuhnPoker}.

Данная игра достаточно проста, чтобы быть решенной аналитически. Правила следующие:
\begin{itemize}
	\item в игре участвуют 2 игрока;
	\item игра начинается с раздачи карт игрокам. Всего имеется 3 карты (1, 2 и 3). Каждый игрок получает одну карту. Причем каждый игрок знает свою карту и не знает карту другого игрока;
	\item по ходу игры игрокам доступны 2 действия «пасс» («п») и «ставка» («с»). Игру начинает первый игрок. Возможны следующие терминальные игровые истории: «пп», «сс», «сп», «псп» и «псс»;
	\item если терминальная игровая история заканчивается на «сс», то игрок с большей картой получает 2 очка, а игрок с меньшей их теряет;
	\item если терминальная игровая история заканчивается на «сп», то сделавший ставку игрок получает 1 очко, а спасовавший игрок теряет 1 очко;
	\item если терминальная игровая история заканчивается на «пп», то игроки получают по 0 очков.
\end{itemize}
Данная игра удобна для базовой проверки алгоритма CFR и часто служит в качестве примера той или иной реализации. Мы можем смоделировать дерево игры и информационные наборы игроков. После $10^7$ итераций алгоритма удалось получить следующий профиль стратегий(Рисунок \ref{fig:figkpst}).
\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\linewidth]{inc/img/kpst}
	\caption{Стратегия для покера Куна}
	\label{fig:figkpst}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\linewidth]{inc/img/kpg}
	\caption{График расчетной эксплуатируемости стратегий для покера Куна}
	\label{fig:figkpg}
\end{figure}
\par
На рисунке \ref{fig:figkpg} представлен график приближенной эксплуатируемости стратегий. На приведенном графике, и в дальнейшем, горизонтальная ось содержит экспоненциальные отметки о числе итераций по основанию 2. Основная часть кода программы представлена в приложении А.

\section{Второй пример. Домино}

В данной работе в качестве основного объекта исследования была выбрана игра «Домино». Однако, спортивный вариант игры обладает значительной комбинаторной сложностью и было бы трудно хранить в памяти все дерево игры. В связи с этим, в данной работе рассматривались некоторые упрощенные варианты.

Из соображений вычислительной сложности целесообразно рассматривать правила игры следующего вида:
\begin{itemize}	
\item имеется набор из не более чем 10 костяшек домино;
\item игроки имеют на руках 2, 3 (размер руки) костяшки;
\item игра может происходить с 2-мя, 3-мя или 4-мя игроками;
\item находящиеся не на руках костяшки раздаются по мере развития игры
\item игру начинает первый игрок
\item все костяшки в процессе игры выкладываются в единственную линию
\item если ход возможен, то он происходит по обычным правилам;
\item в случае, если ход текущего игрока невозможен, то игра на этом заканчивается, и игроки получают выплаты (победитель забирает все очки, и т.к. необходима нулевая сумма, то проигравшая сторона эти очки теряет).
\end{itemize}
\par
Приведенные выше правила игры позволяют на практике сформировать полное решение по методу MCCFR. Фрагмент кода приложения для расчета стратегий представлен в приложении Б.
\par
Для проверки полученного приложения был проведен ряд тестовых запусков. Первый тест состоял в определении профиля стратегий для случая игры с полной информацией. Был взят набор из четырех костяшек, которые раздавались поровну двум игрокам. Это крайне простая игровая ситуация, но по ней можно судить о работоспособности в целом. Ниже приведен полученный профиль стратегий в корневом узле (Рисунок \ref{fig:figd1r}).
\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\linewidth]{inc/img/d1r}
	\caption{Стратегии в корне игры для первого примера домино}
	\label{fig:figd1r}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.4\linewidth]{inc/img/d1s}
	\caption{настройки для первого примера домино}
	\label{fig:figd1s}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\linewidth]{inc/img/d1g}
	\caption{График эксплуатируемости стратегий для первого примера домино}
	\label{fig:figd1g}
\end{figure}
\par
Для второго теста был выбран набор из шести костяшек домино из которых каждый игрок в начале раунда получал на руки две, а остальные 2 раздавались по ходу игры. Приведем фрагмент полученной стратегии (Рисунок \ref{fig:figd2r}).
\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\linewidth]{inc/img/d2r}
	\caption{Стратегии в корне игры для второго примера домино}
	\label{fig:figd2r}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.4\linewidth]{inc/img/d2s}
	\caption{настройки для второго примера домино}
	\label{fig:figd2s}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\linewidth]{inc/img/d2g}
	\caption{График эксплуатируемости стратегий для второго примера домино}
	\label{fig:figd2g}
\end{figure}
\par
Однако, данные примеры не представляют большой комбинаторной сложности. Для проверки производительности был выбран вариант игры на 10 костяшек для двух игроков. Каждый игрок получал на руки по 3 костяшки и оставшиеся 4 раздавались по ходу игры. Под эксплуатироемостью стратегий подразумевается возможная выгода оппонента, если он будет менять только свою стратегию. Будем под ней понимать максимальный приближенно рассчитанный разброс выигрыша изменившего свою стратегию игрока по сравнению с оригинальным профилем. Назовем эту величину $\tau$. Ниже представлен график расчетной эксплуатируемости стратегий в зависимости от числа обучающих итераций (Рисунок \ref{fig:figd3g}).
\begin{figure}[H]
	\centering
	\includegraphics[width=0.5\linewidth]{inc/img/d3s}
	\caption{настройки для третьего примера домино}
	\label{fig:figd3s}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\linewidth]{inc/img/d3g}
	\caption{График эксплуатируемости стратегий для третьего примера домино}
	\label{fig:figd3g}
\end{figure}